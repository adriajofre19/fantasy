---
import LayoutWithNavbar from "../components/LayoutWithNavbar.astro";
import { supabase } from "../lib/supabase";
import { getOrCreateUserTeam, getTeamBudget } from "../lib/fantasy";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
    return Astro.redirect("/signin");
}

let session;
try {
    session = await supabase.auth.setSession({
        refresh_token: refreshToken.value,
        access_token: accessToken.value,
    });
    if (session.error) {
        Astro.cookies.delete("sb-access-token", {
            path: "/",
        });
        Astro.cookies.delete("sb-refresh-token", {
            path: "/",
        });
        return Astro.redirect("/signin");
    }
} catch (error) {
    Astro.cookies.delete("sb-access-token", {
        path: "/",
    });
    Astro.cookies.delete("sb-refresh-token", {
        path: "/",
    });
    return Astro.redirect("/signin");
}

const email = session.data.user?.email || "";
const userId = session.data.user?.id;

// Obtener presupuesto
let budget = 0;
if (userId) {
    const userTeam = await getOrCreateUserTeam(userId);
    if (userTeam) {
        budget = await getTeamBudget(userTeam.id);
    }
}
---

<LayoutWithNavbar title="Panel de Control">
    <div class="container mx-auto px-4 py-8 min-h-screen">
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-2 text-foreground">Bienvenido, {email}</h1>
            <p class="text-muted-foreground text-lg">Gestiona tu equipo de Fantasy NBA</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <a href="/my-team" class="bg-card border border-border rounded-lg p-6 hover:bg-muted/30 transition-colors">
                <h2 class="text-xl font-semibold mb-2 text-foreground">Mi Equipo</h2>
                <p class="text-sm text-muted-foreground">Gestiona tus jugadores titulares y suplentes</p>
            </a>

            <a href="/market" class="bg-card border border-border rounded-lg p-6 hover:bg-muted/30 transition-colors">
                <h2 class="text-xl font-semibold mb-2 text-foreground">Mercado</h2>
                <p class="text-sm text-muted-foreground">Compra jugadores de otros usuarios</p>
            </a>

            <a href="/" class="bg-card border border-border rounded-lg p-6 hover:bg-muted/30 transition-colors">
                <h2 class="text-xl font-semibold mb-2 text-foreground">Jugadores NBA</h2>
                <p class="text-sm text-muted-foreground">Explora todos los jugadores activos</p>
            </a>
        </div>

    </div>
</LayoutWithNavbar>
