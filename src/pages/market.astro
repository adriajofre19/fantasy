---
import LayoutWithNavbar from "../components/LayoutWithNavbar.astro";
import { supabase } from "../lib/supabase";
import { getOrCreateUserTeam, getMarketPlayers, getTeamBudget, getTeamPlayers } from "../lib/fantasy";
import { getPlayers } from "../lib/rapidapi-nba";
import Market from "../components/Market";
import BudgetDisplay from "../components/BudgetDisplay";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
    return Astro.redirect("/signin");
}

let session;
try {
    session = await supabase.auth.setSession({
        refresh_token: refreshToken.value,
        access_token: accessToken.value,
    });
    if (session.error) {
        return Astro.redirect("/signin");
    }
} catch (error) {
    return Astro.redirect("/signin");
}

const userId = session.data.user?.id;
if (!userId) {
    return Astro.redirect("/signin");
}

// Obtener equipo del usuario
const userTeam = await getOrCreateUserTeam(userId);
if (!userTeam) {
    return Astro.redirect("/signin");
}

// Obtener presupuesto del equipo
const budget = await getTeamBudget(userTeam.id);

// Obtener todos los jugadores de la NBA
const nbaPlayersData = await getPlayers(2025);
const nbaPlayers = nbaPlayersData.data || [];

// Obtener jugadores que ya están en el equipo del usuario
const myPlayers = await getTeamPlayers(userTeam.id);
const myPlayerIds = new Set(myPlayers.map(p => p.player_id));

// Función helper para obtener la URL de la imagen del jugador
function getPlayerImageUrl(playerId: number): string {
    // La NBA tiene un formato estándar para las imágenes de jugadores
    // Intentamos múltiples formatos por si alguno falla
    return `https://cdn.nba.com/headshots/nba/latest/1040x760/${playerId}.png`;
}

// Filtrar jugadores que no están en el equipo del usuario y asignar precios aleatorios
const availablePlayers = nbaPlayers
    .filter(p => !myPlayerIds.has(p.id))
    .map(player => {
        // Precio aleatorio entre $50,000 y $1,000,000
        const minPrice = 50000;
        const maxPrice = 1000000;
        const randomPrice = Math.floor(Math.random() * (maxPrice - minPrice + 1)) + minPrice;
        
        // Redondear a múltiplos de $10,000 para que se vea más realista
        const roundedPrice = Math.round(randomPrice / 10000) * 10000;
        
        return {
            player_id: player.id,
            player_name: `${player.first_name} ${player.last_name}`,
            position: player.position || 'N/A',
            team: player.team,
            height_feet: player.height_feet,
            height_inches: player.height_inches,
            weight_pounds: player.weight_pounds,
            price: roundedPrice,
            image_url: getPlayerImageUrl(player.id),
            isFromNBA: true, // Marca para identificar que viene del catálogo NBA
        };
    });
---

<LayoutWithNavbar title="Mercado">
    <div class="container mx-auto px-4 py-8 min-h-screen">
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-2 text-foreground">Mercado de Jugadores</h1>
            <p class="text-muted-foreground text-lg">
                Compra jugadores de otros usuarios
            </p>
        </div>

        <Market 
            client:load
            initialBudget={budget}
            initialPlayers={availablePlayers}
        />

        <div class="mt-8">
            <a href="/my-team" class="inline-block px-6 py-3 border border-border rounded-lg hover:bg-muted transition-colors">
                Volver a mi equipo
            </a>
        </div>
    </div>

</LayoutWithNavbar>

