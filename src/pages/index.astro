---
import Layout from "../layouts/Layout.astro";
import { getPlayers } from "../lib/rapidapi-nba";
import { cache } from "../lib/cache";
import PlayerStatsModal from "../components/PlayerStatsModal";

// Manejar callback de OAuth si viene el c√≥digo en la URL
const { url, redirect } = Astro;
const authCode = url.searchParams.get("code");

if (authCode) {
    // Redirigir al callback con el c√≥digo
    return redirect(`/api/auth/callback?code=${authCode}`);
}

type Player = {
	id: number;
	first_name: string;
	last_name: string;
	position: string;
	height_feet: number | null;
	height_inches: number | null;
	weight_pounds: number | null;
	team: {
		id: number;
		abbreviation: string;
		city: string;
		conference: string;
		division: string;
		full_name: string;
		name: string;
	} | null;
};

// Obtener jugadores activos de la temporada 2025-2026
const season = 2025;
let players: Player[] = [];
let error: string | null = null;
let isRateLimited = false;
let fromCache = false;

// Verificar si hay datos en cach√© antes de hacer la solicitud
// Usar la temporada actual 2025-26
const cacheKey = `players_nba_active_2025_26`;
const cachedData = cache.get<Awaited<ReturnType<typeof getPlayers>>>(cacheKey);
fromCache = cachedData !== null;

try {
	let data: Awaited<ReturnType<typeof getPlayers>>;

	// Si hay datos en cach√©, usarlos directamente sin hacer solicitud a la API
	if (cachedData) {
		data = cachedData;
	} else {
		// Si no hay cach√©, hacer la solicitud (que autom√°ticamente guardar√° en cach√©)
		data = await getPlayers(season, true);
	}

	// Los datos ya vienen filtrados y procesados desde getPlayers
	players = data.data || [];
} catch (e) {
	const errorMessage = e instanceof Error ? e.message : "Error desconocido";
	error = errorMessage;
	isRateLimited =
		errorMessage.includes("429") ||
		errorMessage.includes("Too Many Requests");
	console.error("Error obteniendo jugadores:", e);
}
---

<Layout>
	<div class="container mx-auto px-4 py-8 min-h-screen">
		<div class="mb-8">
			<h1 class="text-4xl font-bold mb-2 text-foreground">
				Jugadores NBA Activos
			</h1>
			<p class="text-muted-foreground text-lg">
				Temporada {season}-{season + 1}
			</p>
		</div>

		{
			error ? (
				<div class="bg-destructive/10 border border-destructive text-destructive px-4 py-3 rounded-lg mb-4">
					<p class="font-semibold">Error al cargar jugadores</p>
					<p class="text-sm mt-1">{error}</p>
					{isRateLimited ? (
						<div class="mt-3 space-y-2">
							<p class="text-sm font-medium">
								‚ö†Ô∏è L√≠mite de solicitudes excedido
							</p>
							<p class="text-sm">
								Has excedido el l√≠mite de solicitudes. El
								sistema ahora usa cach√© para evitar este
								problema.
							</p>
							<p class="text-sm">
								<strong>Soluciones:</strong>
							</p>
							<ul class="text-sm list-disc list-inside ml-2 space-y-1">
								<li>
									Espera unos minutos antes de recargar la
									p√°gina
								</li>
								<li>
									Los datos se guardan en cach√© por 1 hora
								</li>
							</ul>
						</div>
					) : (
						<p class="text-sm mt-2">
							Error al conectar con la API de NBA. Por favor,
							intenta recargar la p√°gina.
						</p>
					)}
				</div>
			) : (
				<>
					<div class="mb-6 flex items-center justify-between flex-wrap gap-4">
						<p class="text-lg">
							Total de jugadores activos:{" "}
							<span class="font-bold">{players.length}</span>
						</p>
						<div class="flex gap-2 flex-wrap">
							{fromCache && (
								<div class="bg-muted px-3 py-1 rounded-md text-sm text-muted-foreground">
									üíæ Datos desde cach√©
								</div>
							)}
						</div>
					</div>

					{players.length === 0 ? (
						<div class="text-center py-12 text-muted-foreground">
							<p class="text-lg">
								No se encontraron jugadores activos.
							</p>
						</div>
					) : (
						<div class="overflow-x-auto rounded-lg border border-border bg-card shadow-sm">
							<table class="w-full border-collapse">
								<thead class="bg-muted/50">
									<tr>
										<th class="px-4 py-4 text-left text-xs font-semibold uppercase tracking-wider text-muted-foreground">
											#
										</th>
										<th class="px-4 py-4 text-left text-xs font-semibold uppercase tracking-wider text-muted-foreground">
											Nombre
										</th>
										<th class="px-4 py-4 text-left text-xs font-semibold uppercase tracking-wider text-muted-foreground">
											Posici√≥n
										</th>
										<th class="px-4 py-4 text-left text-xs font-semibold uppercase tracking-wider text-muted-foreground">
											Equipo
										</th>
										<th class="px-4 py-4 text-left text-xs font-semibold uppercase tracking-wider text-muted-foreground">
											Altura
										</th>
										<th class="px-4 py-4 text-left text-xs font-semibold uppercase tracking-wider text-muted-foreground">
											Peso
										</th>
										<th class="px-4 py-4 text-left text-xs font-semibold uppercase tracking-wider text-muted-foreground">
											Equipo Completo
										</th>
										<th class="px-4 py-4 text-left text-xs font-semibold uppercase tracking-wider text-muted-foreground">
											Conferencia
										</th>
									</tr>
								</thead>
								<tbody class="divide-y divide-border bg-card">
									{players.map((player, index) => {
										const playerFullName = `${player.first_name} ${player.last_name}`;
										return (
											<tr
												class="hover:bg-muted/30 transition-colors duration-150 cursor-pointer"
												data-player-id={player.id}
												data-player-name={
													playerFullName
												}
											>
												<td class="px-4 py-4 text-sm text-muted-foreground">
													{index + 1}
												</td>
												<td class="px-4 py-4 text-sm font-semibold text-foreground">
													{player.first_name}{" "}
													{player.last_name}
												</td>
												<td class="px-4 py-4 text-sm text-foreground">
													{player.position || (
														<span class="text-muted-foreground">
															N/A
														</span>
													)}
												</td>
												<td class="px-4 py-4 text-sm">
													<span class="inline-flex items-center px-2 py-1 rounded-md bg-primary/10 text-primary font-medium text-xs">
														{player.team
															?.abbreviation ||
															"N/A"}
													</span>
												</td>
												<td class="px-4 py-4 text-sm text-foreground">
													{player.height_feet !==
														null &&
													player.height_inches !==
														null ? (
														`${player.height_feet}'${player.height_inches}"`
													) : (
														<span class="text-muted-foreground">
															N/A
														</span>
													)}
												</td>
												<td class="px-4 py-4 text-sm text-foreground">
													{player.weight_pounds !==
													null ? (
														`${player.weight_pounds} lbs`
													) : (
														<span class="text-muted-foreground">
															N/A
														</span>
													)}
												</td>
												<td class="px-4 py-4 text-sm text-foreground">
													{player.team?.full_name || (
														<span class="text-muted-foreground">
															N/A
														</span>
													)}
												</td>
												<td class="px-4 py-4 text-sm">
													<span
														class={`inline-flex items-center px-2 py-1 rounded-md text-xs font-medium ${
															player.team
																?.conference ===
															"East"
																? "bg-blue-500/10 text-blue-700 dark:text-blue-400"
																: player.team
																			?.conference ===
																	  "West"
																	? "bg-orange-500/10 text-orange-700 dark:text-orange-400"
																	: "bg-muted text-muted-foreground"
														}`}
													>
														{player.team
															?.conference ||
															"N/A"}
													</span>
												</td>
											</tr>
										);
									})}
								</tbody>
							</table>
						</div>
					)}
				</>
			)
		}
	</div>

	<PlayerStatsModal client:load />
</Layout>

<style>
	.container {
		max-width: 1600px;
	}

	/* Mejoras de estilo para la tabla */
	table {
		min-width: 100%;
	}

	/* Estilos responsivos */
	@media (max-width: 768px) {
		.container {
			padding-left: 1rem;
			padding-right: 1rem;
		}

		table {
			font-size: 0.875rem;
		}

		th,
		td {
			padding: 0.75rem 0.5rem;
		}
	}

	/* Animaci√≥n suave para las filas */
	tr {
		transition: background-color 0.15s ease-in-out;
	}

	/* Mejora de legibilidad */
	tbody tr:nth-child(even) {
		background-color: transparent;
	}

	tbody tr:hover {
		background-color: hsl(var(--muted) / 0.3);
	}
</style>
